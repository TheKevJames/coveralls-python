version: 2.1

orbs:
  linter: talkiq/linter@4

executors:
  py37:
    docker:
      - image: python:3.7-alpine
    resource_class: small
  py38:
    docker:
      - image: python:3.8-alpine
    resource_class: small
  py39:
    docker:
      - image: python:3.9-alpine
    resource_class: small
  py310:
    docker:
      - image: python:3.10-alpine
    resource_class: small
  pypy735:  # py37
    docker:
      - image: pypy:3-7.3.5-slim
    resource_class: small
  pypy737:  # py37+py38
    docker:
      - image: pypy:3-7.3.7-slim
    resource_class: small
  pypy7311:  # py38+py39
    docker:
      - image: pypy:3-7.3.11-slim
    resource_class: small
  pypy73:  # py39+py310
    docker:
      - image: pypy:3-7.3-slim
    resource_class: small

jobs:
  toxpy:
    executor: <<parameters.executor>>
    parameters:
      executor:
        type: executor
    steps:
      - run: apk add --no-cache git
      - checkout
      - run: pip install --upgrade tox
      - run: tox run -f "${CIRCLE_JOB//test-}"
      - run: tox run -e upload

  toxpypy:
    executor: <<parameters.executor>>
    parameters:
      executor:
        type: executor
    steps:
      - run: apt-get update -qy
      - run: apt-get install -qy --no-install-recommends git
      - checkout
      - run: pip install --upgrade tox
      - run: tox run -f pypy3
      - run: tox run -e upload

workflows:
  test:
    jobs:
      - linter/pre-commit:
          executor: py37
          pre-steps:
            - run: apk add --no-cache git
      - toxpy:
          name: test-<<matrix.executor>>
          matrix:
            parameters:
              executor: [py37, py38, py39, py310]
      - toxpypy:
          name: test-<<matrix.executor>>
          matrix:
            parameters:
              executor: [pypy735, pypy737, pypy7311, pypy73]
